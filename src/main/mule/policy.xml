<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd">
	<sub-flow name="create-policy-sub-flow" doc:id="154f9307-fb01-4936-bf9e-88153007d765" >
		<logger level="INFO" doc:name="request recieved" doc:id="a0c5b4a0-aac4-462c-b4df-e9eb14ab533e" message="request recieved to create policy"/>
		<ee:transform doc:name="set variable" doc:id="c0dd430e-6f00-4cb4-8663-79e6ba9a25ff" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="requestPayload" ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-variable>
				<ee:set-variable variableName="username" ><![CDATA[%dw 2.0
output application/json
---
attributes.headers.userName]]></ee:set-variable>
				<ee:set-variable variableName="policyId" ><![CDATA[%dw 2.0
output application/json
---
uuid()]]></ee:set-variable>
				<ee:set-variable variableName="folderLocation" ><![CDATA[%dw 2.0
output application/json
---
p("policyFolderLocation")]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="set payload" doc:id="27c4dc31-3a6c-4368-b5d2-061ed83041f9" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload ++ {"policyId" : vars.policyId, "createdBy" : vars.username}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<file:write doc:id="8b7191f1-ba5f-4d66-9ed9-46a384d652ad" path='#[vars.folderLocation ++ vars.policyId ++ ".json"]'/>
		<ee:transform doc:name="Transform Message" doc:id="e64db0be-8aca-4b33-95db-880599b7137b" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"message" : "policy created successfully",
	"policyId" : vars.policyId
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="request completed" doc:id="2cd3be79-c04c-40df-9ffa-643ed6f5533f" message="request completed successfully to create policy"/>
	</sub-flow>
	<sub-flow name="get-policy-details-Sub-Flow" doc:id="bfe42ffc-0ff8-45b2-98bb-450167ad0668" >
		<logger level="INFO" doc:name="request recieved" doc:id="bd85bbe4-c2fd-4483-a0cf-b0a7f56f7dad" message="request recieved to get policy details"/>
		<ee:transform doc:name="set variable" doc:id="45fbf017-71ad-40f2-960d-2aa905958bec" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="policyId" ><![CDATA[%dw 2.0
output application/json
---
attributes.uriParams.policyId]]></ee:set-variable>
				<ee:set-variable variableName="folderLocation" ><![CDATA[%dw 2.0
output application/json
---
p("policyFolderLocation")]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<try doc:name="Try" doc:id="90e73850-ebaa-4be4-b922-fd5258bb98b9" >
			<file:read doc:name="Read" doc:id="08b28cb4-b757-466b-bdb9-6d6d7d140fa2" path='#[vars.folderLocation ++ vars.policyId ++ ".json"]' />
			<error-handler >
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="f671f4a2-a4bc-47c1-abf8-5d8807116c89" >
					<ee:transform doc:name="set error response" doc:id="cc028d31-e128-4aa8-b7ad-413396559aaf">
						<ee:message>
							<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"status" : "failed",
	"message" : "policy Id provided is invalid"
}]]></ee:set-payload>
						</ee:message>
						<ee:variables >
							<ee:set-variable variableName="httpStatus" ><![CDATA[%dw 2.0
output application/json
---
400]]></ee:set-variable>
						</ee:variables>
					</ee:transform>
				</on-error-continue>
			</error-handler>
		</try>
		<logger level="INFO" doc:name="request completed" doc:id="82b36baa-e4cd-46cb-a28f-d623ab73e93d" message="request completed to get policy details"/>
	</sub-flow>
</mule>
